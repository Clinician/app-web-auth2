<!DOCTYPE html>
<html>
<head>
  <base href="/access/v1/">
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
  <title>Pryv â€” Reset password</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500,700,400italic|Roboto+Condensed:400,300,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://pryv.github.io/app-web/styles/vendor.min.css"/>
  <link rel="stylesheet" type="text/css" href="media/styles/access.css"/>
</head>
<body>
  <div id="simple-page-wrapper">
    <img class="logo" src="/access/v1/media/images/logo-minimal.png"/>

    <div id="error" class="alert alert-danger" style="display: none;"></div>

    <form role="form" id="setPass">
      <h1>Set a new password</h1>

      <div class="form-group">
        <label>Username</label>
        <input class="form-control" name="username" type="text" required>
      </div>

      <div class="form-group">
        <label>New password</label>
        <input class="form-control" name="password" type="password" required>
      </div>

      <div class="form-group">
        <label>Re-type new password</label>
        <input class="form-control" name="rePassword" type="password" required>
      </div>

      <div class="form-group">
        <input class="btn btn-success btn-block" type="submit" value="Save">
      </div>
    </form>

    <form role="form" id="resetForm">
      <h1>Request password reset</h1>

      <div class="form-group">
        <label>Please enter your username</label>
        <input class="form-control" name="username" type="text" required>
      </div>

      <div class="form-group">
        <input class="btn btn-success btn-block" type="submit" value="Send request">
      </div>
    </form>

    <div id="requestSent" class="panel panel-default" style="display: none;">
      <div class="panel-body">
        <div class="resend-password-wrapper" style="color: #000;">
          <h3>We've sent password reset instructions to your e-mail address</h3>

          <p>If you don't receive a message within a few minutes, you may want to have a look in your junk mail.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>

  <script>
    var getURLParameter = function (name) {
      return decodeURIComponent((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,""])[1]);
    };
    var getEnvironment = function (api) {
      var env = document.location.host.split('.').slice(-1).pop();
      if (env === 'li') {
        return api ? 'in' : env;
      }
      if (env === 'me') {
        return api ? 'io' : env;
      }
      return api ? 'in' : 'li';
    }
    var requestResetPassword = function (e) {
      e.preventDefault();
      var username = $('#resetForm input[name=username]').val();
      if (username && username.length > 0) {
        $('#resetForm input[type=submit]').prop('disabled', true);
        $.post('https://' + username + '.pryv.' + getEnvironment(true) + '/account/request-password-reset', {appId: 'static-web'})
            .done(function () {
              $('#error').text('Username unknown').hide().empty();
              $('#resetForm').hide();
              $('#requestSent').show();
              $('#resetForm input[type=submit]').prop('disabled', false);
            })
            .fail(function () {
              $('#error').text('Username unknown').show();
              $('#resetForm input[type=submit]').prop('disabled', false);
            })
      }

    };
    var setPassword = function (e) {
      e.preventDefault();
      var username = $('#setPass input[name=username]').val();
      var pass = $('#setPass input[name=password]').val();
      var rePass = $('#setPass input[name=rePassword]').val();
      if (username && username.length > 0 && pass && pass === rePass) {
        $('#setPass input[type=submit]').prop('disabled', true);
        $.post('https://' + username + '.pryv.' + getEnvironment(true) + '/account/reset-password',
            {newPassword: pass, appId: 'static-web', resetToken : getURLParameter('resetToken')})
            .done(function () {
                window.location.replace('https://' + username + '.pryv.' + getEnvironment(false) + '/#/SignIn');
            })
            .fail(function () {
              $('#error').text('Username unknown').show();
              $('#setPass input[type=submit]').prop('disabled', false);
            })
      }

    };
    $(document).ready(function(){
      var $resetForm = $('#resetForm');
      var $changePass = $('#setPass');
      var resetToken = getURLParameter('resetToken');
      $resetForm.on('submit', requestResetPassword);
      $changePass.on('submit', setPassword);
      if (resetToken) {
        console.log(resetToken);
        $resetForm.hide();
        $changePass.show();
      } else {
        $resetForm.show();
        $changePass.hide();
      }
    });
  </script>
</body>
</html>
